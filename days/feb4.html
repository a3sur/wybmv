<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>feb4 â€” Jolene Simulator</title>
<style>
body{
    margin:0;
    background:#c0c0c0;
    font-family:Chicago, monospace;
    display:flex;
    justify-content:center;
}
.window{
    margin-top:20px;
    width:520px;
    background:#fff;
    border:2px solid #000;
    box-shadow:4px 4px #000;
}
.titlebar{
    background:#000;
    color:#fff;
    padding:4px 8px;
    font-size:14px;
    letter-spacing:0.35em;
    text-align:center;
}
.content{padding:10px;}
canvas{background:#111;display:block;margin:auto;}
#hud{
    display:flex;
    justify-content:space-between;
    margin-top:6px;
}
button{font-family:monospace;padding:4px 8px;cursor:pointer;}
.hidden{display:none;}
</style>
</head>
<body>

<div class="window" id="gameWindow">
    <div class="titlebar">JOLENE-SIMULATOR.EXE</div>
    <div class="content">
        <canvas id="game" width="480" height="320"></canvas>
        <div id="hud">
            <div>Items: <span id="score">0</span>/7</div>
            <div>Time: <span id="time">0.0</span>s</div>
            <div>Best: <span id="best">--</span></div>
        </div>
        <div id="end" class="hidden" style="text-align:center;margin-top:10px;">
            <div id="result"></div>
            <button onclick="startGame()">Replay</button>
            <button onclick="location.href='../loveme.html'">Back</button>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const TILE = 20;
const COLS = 24;
const ROWS = 16;

let grid, player, items, collected, startTime, playing, frame;

const ITEM_LIST = [
    {emoji:"ðŸ±"},
    {emoji:"ðŸ§»"},
    {emoji:"ðŸ“˜"},
    {emoji:"ðŸ–Šï¸"},
    {emoji:"ðŸ¶"},
    {emoji:"ðŸŒ"},
    {emoji:"ðŸ—"}
];
const SECRET_ITEM = {emoji:"ðŸ’Ž"};

const scoreEl = score;
const timeEl = time;
const bestEl = best;
const endEl = end;
const resultEl = result;

const saved = localStorage.getItem("joleneBest");
if(saved) bestEl.textContent = saved + "s";

let secretMode = false;
let devBuffer = "";

function startGame(){
    collected = 0;
    frame = 0;
    playing = true;
    endEl.classList.add("hidden");

    generateMaze();
    player = {x:1,y:1};

    // spawn items
    if(secretMode){
        items = [spawnItem(SECRET_ITEM)];
        document.querySelector("#hud div:nth-child(1)").textContent = "Items: 0/1";
    } else {
        items = ITEM_LIST.map(spawnItem);
        document.querySelector("#hud div:nth-child(1)").textContent = "Items: 0/7";
    }

    scoreEl.textContent = 0;
    startTime = performance.now();
    requestAnimationFrame(loop);
}

function generateMaze(){
    grid = Array.from({length:ROWS},()=>Array(COLS).fill(1));

    function carve(x,y){
        grid[y][x]=0;
        shuffle([[2,0],[-2,0],[0,2],[0,-2]]).forEach(([dx,dy])=>{
            const nx=x+dx, ny=y+dy;
            if(nx>0&&ny>0&&nx<COLS-1&&ny<ROWS-1&&grid[ny][nx]){
                grid[y+dy/2][x+dx/2]=0;
                carve(nx,ny);
            }
        });
    }
    carve(1,1);
}

function spawnItem(base){
    let x,y;
    do{
        x = rand(1,COLS-2);
        y = rand(1,ROWS-2);
    }while(grid[y][x] || (x===1&&y===1));

    return {...base, x, y, dx:0, dy:0, cooldown: rand(40,80), got:false};
}

document.addEventListener("keydown",e=>{
    if(!playing) return;
    let nx=player.x, ny=player.y;
    if(e.key==="ArrowUp") ny--;
    if(e.key==="ArrowDown") ny++;
    if(e.key==="ArrowLeft") nx--;
    if(e.key==="ArrowRight") nx++;
    if(!grid[ny]?.[nx]){player.x=nx; player.y=ny;}

    // developer codes
    devBuffer += e.key.toLowerCase();
    if(devBuffer.endsWith("dev14")){ 
        secretMode = true;
        collected = 0;
        playing = false;
        startGame();
    }
    if(devBuffer.endsWith("dev26")) showNotepad();
    if(devBuffer.length>10) devBuffer="";
});

function loop(){
    if(!playing) return;
    frame++;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // maze
    ctx.fillStyle="#333";
    for(let y=0;y<ROWS;y++){
        for(let x=0;x<COLS;x++){
            if(grid[y][x]) ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
        }
    }

    // items
    items.forEach(i=>{
        if(i.got) return;
        i.cooldown--;
        if(i.cooldown<=0){
            const dirs = shuffle([[1,0],[-1,0],[0,1],[0,-1]]);
            for(const [dx,dy] of dirs){
                if(!grid[i.y+dy]?.[i.x+dx]){
                    i.dx=dx; i.dy=dy; break;
                }
            }
            i.cooldown = rand(40,80);
        }
        if(frame%22===0){
            const nx=i.x+i.dx, ny=i.y+i.dy;
            if(!grid[ny]?.[nx]){i.x=nx; i.y=ny;}
        }
        ctx.font="16px monospace";
        ctx.fillText(i.emoji,i.x*TILE+2,i.y*TILE+16);

        if(player.x===i.x && player.y===i.y){
            i.got=true;
            collected++;
            scoreEl.textContent = collected;
        }
    });

    // player
    ctx.fillStyle="lime";
    ctx.fillRect(player.x*TILE,player.y*TILE,TILE,TILE);

    const elapsed = ((performance.now()-startTime)/1000).toFixed(1);
    timeEl.textContent = elapsed;

    if(collected >= (secretMode?1:7)){
        finish(elapsed);
        return;
    }

    requestAnimationFrame(loop);
}

function finish(t){
    playing=false;

    if(secretMode){
        showNotepad();
        return;
    }

    endEl.classList.remove("hidden");
    resultEl.textContent=`You collected everything in ${t}s!`;

    const best = localStorage.getItem("joleneBest");
    if(!best || t<best){
        localStorage.setItem("joleneBest",t);
        bestEl.textContent = t+"s";
    }

    if(t<20) localStorage.setItem("joleneSecretNext","true");
}

// full screen retro notepad
function showNotepad(){
    document.body.innerHTML="";
    const win = document.createElement("div");
    win.className="window";
    win.style.width="400px";
    win.style.margin="50px auto";
    win.innerHTML=`
        <div class="titlebar">i-confess.txt</div>
        <div class="content" style="padding:20px; font-family:monospace;">
            <p>
i confess
i cant think of anyone else

i confess
i cant, without you
i cant dream of a world
without you

eyes, hair
lips, waist
legs, feet
heart, mind

i confess
i cant get you out of my head
i confess, i need you. i confess
i want you, i confess

i yearn for your soft touch
your warm embrace
your kisses in the morning

i confess
you are my love

            </p>
            <button onclick="location.href='../loveme.html'">Back</button>
        </div>
    `;
    document.body.appendChild(win);
}

function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function shuffle(a){return a.sort(()=>Math.random()-0.5);}

// check for secret unlock on next play
if(localStorage.getItem("joleneSecretNext")==="true") secretMode = true;

startGame();
</script>
</body>
</html>
